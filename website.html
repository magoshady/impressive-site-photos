<!DOCTYPE html>
<html lang="en">
<head>
    <title>Energy Assessment Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px auto;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .header-section {
            margin-bottom: 30px;
        }
        .logo {
            max-width: 200px;
            height: auto;
            margin-bottom: 20px;
        }
        .page-title {
            font-size: 24px;
            color: #333;
            margin-top: 15px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        h2 {
            text-align: center;
            margin-bottom: 50px !important;
            color: #333;
            font-size: 28px;
        }
        label {
            font-weight: bold;
            display: block;
            margin-top: 30px;
            margin-bottom: 8px;
            color: #333;
            font-size: 18px;
        }
        input[type="text"], input[type="email"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: #f4f4f4;
        }
        .file-upload-container {
            margin-top: 10px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background-color: #f4f4f4;
            transition: border-color 0.3s ease;
        }
        .file-upload-container.dragover {
            border-color: #007bff;
            background-color: #e8e8e8;
        }
        .file-upload-container input[type="file"] {
            width: 100%;
            padding: 10px;
            border: none;
            background: none;
            cursor: pointer;
        }
        .single-file-upload {
            margin-top: 10px;
        }
        .single-file-upload input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f4f4f4;
            cursor: pointer;
        }
        .file-preview {
            margin-top: 10px;
            padding: 10px;
            background-color: transparent;
            border-radius: 5px;
            font-size: 14px;
        }
        .file-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        .file-list li {
            background-color: #f4f4f4;
            padding: 8px 12px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .remove-file {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .remove-file:hover {
            background-color: #c82333;
        }
        button[type="submit"] {
            width: 100%;
            background-color: #e0001a;
            color: white;
            padding: 12px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 25px !important;
        }
        button[type="submit"]:hover {
            background-color: #b00015;
        }
        .required {
            color: #dc3545;
        }
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }
        .drag-drop-text {
            color: #666;
            margin-bottom: 10px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #e0001a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text {
            color: white;
            font-size: 18px;
            margin-top: 20px;
            text-align: center;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .form-disabled {
            pointer-events: none;
            opacity: 0.6;
        }
    </style>
    <script>
        let switchboardFiles = [];
        let energyBillFiles = [];

        document.addEventListener("DOMContentLoaded", function() {
            // Check for URL parameters and auto-fill fields
            const params = new URLSearchParams(window.location.search);
            
            // Auto-fill Name field if provided in URL
            const name = params.get('Name');
            if (name) {
                document.getElementById("name").value = decodeURIComponent(name);
            }
            
            // Auto-fill Email field if provided in URL
            const email = params.get('Email');
            if (email) {
                document.getElementById("email").value = decodeURIComponent(email);
            }
            
            // Auto-fill ID field if provided in URL, otherwise generate unique ID
            const urlId = params.get('id');
            if (urlId) {
                document.getElementById("id").value = decodeURIComponent(urlId);
            } else {
                const uniqueId = 'EA_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                document.getElementById("id").value = uniqueId;
            }

            // Switchboard Photos drag & drop functionality
            const switchboardContainer = document.getElementById("switchboard-container");
            const switchboardInput = document.getElementById("switchboard-photos");

            switchboardContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                switchboardContainer.classList.add('dragover');
            });

            switchboardContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                switchboardContainer.classList.remove('dragover');
            });

            switchboardContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                switchboardContainer.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleSwitchboardFiles(files);
            });

            switchboardInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                handleSwitchboardFiles(files);
            });



            // Energy bill handling
            document.getElementById("energy-bill").addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                handleEnergyBillFiles(files);
                e.target.value = ""; // Reset input to allow re-selecting same files
            });

            // Form submission
            document.getElementById("energy-form").addEventListener("submit", function(event) {
                event.preventDefault();

                // Validation
                if (energyBillFiles.length === 0) {
                    document.getElementById("energy-bill-error").textContent = "At least one energy bill is required.";
                    return;
                }

                // Show loading overlay and disable form
                showLoading();

                // Prepare form data for webhook submission
                const formData = new FormData();
                formData.append('name', document.getElementById("name").value);
                formData.append('email', document.getElementById("email").value);
                formData.append('id', document.getElementById("id").value);
                
                // Add switchboard photos
                switchboardFiles.forEach((file, index) => {
                    formData.append(`switchboard_photo_${index}`, file);
                });
                
                // Add energy bills
                energyBillFiles.forEach((file, index) => {
                    formData.append(`energy_bill_${index}`, file);
                });
                
                // Add metadata
                formData.append('switchboard_photos_count', switchboardFiles.length.toString());
                formData.append('energy_bills_count', energyBillFiles.length.toString());
                formData.append('page_url', window.location.href);
                formData.append('page_title', document.title);
                formData.append('submission_time', new Date().toISOString());

                // Submit to n8n webhook
                fetch('https://n8n.nuevaenergy.com.au/webhook/impressive-form-submission', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    hideLoading();
                    if (response.ok) {
                        alert("Form submitted successfully!");
                        location.reload();
                    } else {
                        throw new Error('Network response was not ok');
                    }
                })
                .catch(error => {
                    hideLoading();
                    alert("Error submitting form. Please try again.");
                    console.error("Submission error:", error);
                });
            });
        });

        function handleSwitchboardFiles(files) {
            const validFiles = files.filter(file => isValidImageOrVideo(file));
            switchboardFiles = [...switchboardFiles, ...validFiles];
            updateSwitchboardPreview();
        }

        function isValidImageOrVideo(file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/heic', 'image/heif', 'video/mp4', 'video/mov', 'video/avi'];
            return validTypes.includes(file.type.toLowerCase());
        }

        function updateSwitchboardPreview() {
            const preview = document.getElementById("switchboard-preview");
            if (switchboardFiles.length === 0) {
                preview.innerHTML = "";
                return;
            }

            const fileList = document.createElement("ul");
            fileList.className = "file-list";

            switchboardFiles.forEach((file, index) => {
                const listItem = document.createElement("li");
                listItem.innerHTML = `
                    <span>${file.name}</span>
                    <button type="button" class="remove-file" onclick="removeSwitchboardFile(${index})">Remove</button>
                `;
                fileList.appendChild(listItem);
            });

            preview.innerHTML = "";
            preview.appendChild(fileList);
        }

        function removeSwitchboardFile(index) {
            switchboardFiles.splice(index, 1);
            updateSwitchboardPreview();
        }

        function handleEnergyBillFiles(files) {
            // Filter for PDF files only
            const pdfFiles = files.filter(file => file.type === 'application/pdf');
            
            // Check if any non-PDF files were selected
            if (pdfFiles.length !== files.length) {
                document.getElementById("energy-bill-error").textContent = "Only PDF files are accepted.";
                return;
            }
            
            // Check if adding these files would exceed the limit
            const totalFiles = energyBillFiles.length + pdfFiles.length;
            if (totalFiles > 4) {
                document.getElementById("energy-bill-error").textContent = "Maximum 4 PDF files allowed.";
                return;
            }
            
            // Add files to array
            energyBillFiles = [...energyBillFiles, ...pdfFiles];
            document.getElementById("energy-bill-error").textContent = "";
            updateEnergyBillPreview();
        }

        function updateEnergyBillPreview() {
            const preview = document.getElementById("energy-bill-preview");
            if (energyBillFiles.length === 0) {
                preview.innerHTML = "";
                return;
            }

            const fileList = document.createElement("ul");
            fileList.className = "file-list";

            energyBillFiles.forEach((file, index) => {
                const listItem = document.createElement("li");
                listItem.innerHTML = `
                    <span>${file.name}</span>
                    <button type="button" class="remove-file" onclick="removeEnergyBillFile(${index})">Remove</button>
                `;
                fileList.appendChild(listItem);
            });

            preview.innerHTML = "";
            preview.appendChild(fileList);
        }

        function removeEnergyBillFile(index) {
            energyBillFiles.splice(index, 1);
            updateEnergyBillPreview();
        }

        function showLoading() {
            document.getElementById("loading-overlay").style.display = "flex";
            document.getElementById("energy-form").classList.add("form-disabled");
        }

        function hideLoading() {
            document.getElementById("loading-overlay").style.display = "none";
            document.getElementById("energy-form").classList.remove("form-disabled");
        }
    </script>
</head>
<body>
    <div class="header-section">
        <img src="https://i.imgur.com/35Tn3Qx.png" alt="Company Logo" class="logo">
        <div class="page-title">Please upload the information required to help us with your project</div>
    </div>
    <form id="energy-form">
        <!-- Hidden ID field -->
        <input type="hidden" id="id" name="id">

        <label for="name">Name <span class="required">*</span>:</label>
        <input type="text" id="name" name="name" placeholder="Enter your full name" required>

        <label for="email">Email <span class="required">*</span>:</label>
        <input type="email" id="email" name="email" placeholder="Enter your email address" required>

        <label for="switchboard-photos">Switchboard and Preferred Battery Location Photos:</label>
        <div class="file-upload-container" id="switchboard-container">
            <div class="drag-drop-text">Drag and drop files here or click to select</div>
            <input type="file" id="switchboard-photos" name="switchboard_photos" multiple accept="image/*,video/*,.heic,.HEIC">
            <small></small>
        </div>
        <div id="switchboard-preview" class="file-preview"></div>

        <label for="energy-bill">Energy Bill <span class="required">*</span>:</label>
        <div class="single-file-upload">
            <input type="file" id="energy-bill" name="energy_bill" accept=".pdf" multiple>
            <small>Accepts PDF files only. You can upload 1-4 files.</small>
        </div>
        <div id="energy-bill-preview" class="file-preview"></div>
        <div id="energy-bill-error" class="error-message"></div>

        <button type="submit">Submit</button>
    </form>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Submitting your form...<br>Please wait</div>
        </div>
    </div>
</body>
</html> 